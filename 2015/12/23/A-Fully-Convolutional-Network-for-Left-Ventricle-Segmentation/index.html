<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="FCN,Segmentation,deep learning," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="A Fully Convolutional Network for Left Ventricle Segmentation by Vu Tran, Data Scientist, Booz Allen Hamilton 
Development Environment获得FCN的步骤如下,FCN尚未合并到caffe中去，因此需要单独切换branch，然后编译1234git clone https:">
<meta property="og:type" content="article">
<meta property="og:title" content="A Fully Convolutional Network for Left Ventricle Segmentation">
<meta property="og:url" content="http://yoursite.com/2015/12/23/A-Fully-Convolutional-Network-for-Left-Ventricle-Segmentation/index.html">
<meta property="og:site_name" content="Shuai's blog">
<meta property="og:description" content="A Fully Convolutional Network for Left Ventricle Segmentation by Vu Tran, Data Scientist, Booz Allen Hamilton 
Development Environment获得FCN的步骤如下,FCN尚未合并到caffe中去，因此需要单独切换branch，然后编译1234git clone https:">
<meta property="og:updated_time" content="2015-12-23T11:55:04.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="A Fully Convolutional Network for Left Ventricle Segmentation">
<meta name="twitter:description" content="A Fully Convolutional Network for Left Ventricle Segmentation by Vu Tran, Data Scientist, Booz Allen Hamilton 
Development Environment获得FCN的步骤如下,FCN尚未合并到caffe中去，因此需要单独切换branch，然后编译1234git clone https:">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'always',
    motion: true
  };
</script>

  <title> A Fully Convolutional Network for Left Ventricle Segmentation | Shuai's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Shuai's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">On the way</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                A Fully Convolutional Network for Left Ventricle Segmentation
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-12-23T19:51:16+08:00" content="2015-12-23">
              2015-12-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/deep-learning/" itemprop="url" rel="index">
                    <span itemprop="name">deep learning</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/12/23/A-Fully-Convolutional-Network-for-Left-Ventricle-Segmentation/#comments" itemprop="discussionUrl">
                <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/23/A-Fully-Convolutional-Network-for-Left-Ventricle-Segmentation/" itemprop="commentsCount"></span>
              </a>
            </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><h1 id="A_Fully_Convolutional_Network_for_Left_Ventricle_Segmentation"><a href="#A_Fully_Convolutional_Network_for_Left_Ventricle_Segmentation" class="headerlink" title="A Fully Convolutional Network for Left Ventricle Segmentation"></a>A Fully Convolutional Network for Left Ventricle Segmentation</h1><p><strong> by Vu Tran, Data Scientist, Booz Allen Hamilton </strong></p>
<h2 id="Development_Environment"><a href="#Development_Environment" class="headerlink" title="Development Environment"></a>Development Environment</h2><p>获得FCN的步骤如下,FCN尚未合并到caffe中去，因此需要单独切换branch，然后编译<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> <span class="title">https</span>://github.com/longjon/caffe.git</span><br><span class="line">mv caffe caffe_FCN</span><br><span class="line">cd caffe_FCN</span><br><span class="line">git checkout future</span><br></pre></td></tr></table></figure></p>
<p>为了能够查看DICOM格式的图片，要安装如下软件：<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip <span class="keyword">install</span> pydicom</span><br></pre></td></tr></table></figure></p>
<p>输入ipython notebook pylib inline，打开ipython，然后运行如下代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dicom, lmdb, cv2, re, sys</span><br><span class="line"><span class="keyword">import</span> os, fnmatch, shutil, subprocess</span><br><span class="line"><span class="keyword">from</span> IPython.utils <span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">np.random.seed(<span class="number">1234</span>)</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">%matplotlib inline</span><br><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line">warnings.filterwarnings(<span class="string">'ignore'</span>) <span class="comment"># we ignore a RuntimeWarning produced from dividing by zero</span></span><br><span class="line"></span><br><span class="line">CAFFE_ROOT = <span class="string">"/path/to/caffe_FCN/"</span></span><br><span class="line">caffe_path = os.path.join(CAFFE_ROOT, <span class="string">"python"</span>)</span><br><span class="line"><span class="keyword">if</span> caffe_path <span class="keyword">not</span> <span class="keyword">in</span> sys.path:</span><br><span class="line">    sys.path.insert(<span class="number">0</span>, caffe_path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> caffe</span><br><span class="line"></span><br><span class="line">print(<span class="string">"\nSuccessfully imported packages, hooray!\n"</span>)</span><br></pre></td></tr></table></figure></p>
<p>运行上面一步的时候发现python lmdb没装，安装命令如下：<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip <span class="keyword">install</span> lmdb</span><br></pre></td></tr></table></figure></p>
<h2 id="Tutorial_Walkthrough"><a href="#Tutorial_Walkthrough" class="headerlink" title="Tutorial Walkthrough"></a>Tutorial Walkthrough</h2><h3 id="Step_1_3A_Load_the_Sunnybrook_dataset"><a href="#Step_1_3A_Load_the_Sunnybrook_dataset" class="headerlink" title="Step 1: Load the Sunnybrook dataset"></a>Step 1: Load the Sunnybrook dataset</h3><p>Sunnybrook数据集包含了训练集和对应的ground truth contours(轮廓)，用来评价自动对 MRI SAX扫描的DICOM格式图片进行自动LV分割的方法。数据集提供了如下ground truth contours：the endocardium, the epicardium, and the two largest papillary muscles.本文只关注心内膜endocardium，对应着对应者心脏收缩舒张周期中 contours文件名中i部分。这部分代码主要是将数据集转化为lmdb格式：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">SAX_SERIES = &#123;</span><br><span class="line">    <span class="comment"># challenge training</span></span><br><span class="line">    <span class="string">"SC-HF-I-1"</span>: <span class="string">"0004"</span>,</span><br><span class="line">    <span class="string">"SC-HF-I-2"</span>: <span class="string">"0106"</span>,</span><br><span class="line">    <span class="string">"SC-HF-I-4"</span>: <span class="string">"0116"</span>,</span><br><span class="line">    <span class="string">"SC-HF-I-40"</span>: <span class="string">"0134"</span>,</span><br><span class="line">    <span class="string">"SC-HF-NI-3"</span>: <span class="string">"0379"</span>,</span><br><span class="line">    <span class="string">"SC-HF-NI-4"</span>: <span class="string">"0501"</span>,</span><br><span class="line">    <span class="string">"SC-HF-NI-34"</span>: <span class="string">"0446"</span>,</span><br><span class="line">    <span class="string">"SC-HF-NI-36"</span>: <span class="string">"0474"</span>,</span><br><span class="line">    <span class="string">"SC-HYP-1"</span>: <span class="string">"0550"</span>,</span><br><span class="line">    <span class="string">"SC-HYP-3"</span>: <span class="string">"0650"</span>,</span><br><span class="line">    <span class="string">"SC-HYP-38"</span>: <span class="string">"0734"</span>,</span><br><span class="line">    <span class="string">"SC-HYP-40"</span>: <span class="string">"0755"</span>,</span><br><span class="line">    <span class="string">"SC-N-2"</span>: <span class="string">"0898"</span>,</span><br><span class="line">    <span class="string">"SC-N-3"</span>: <span class="string">"0915"</span>,</span><br><span class="line">    <span class="string">"SC-N-40"</span>: <span class="string">"0944"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SUNNYBROOK_ROOT_PATH = <span class="string">"./data/Sunnybrook_data/"</span></span><br><span class="line"></span><br><span class="line">TRAIN_CONTOUR_PATH = os.path.join(SUNNYBROOK_ROOT_PATH,</span><br><span class="line">                            <span class="string">"Sunnybrook Cardiac MR Database ContoursPart3"</span>,</span><br><span class="line">                            <span class="string">"TrainingDataContours"</span>)</span><br><span class="line">TRAIN_IMG_PATH = os.path.join(SUNNYBROOK_ROOT_PATH,</span><br><span class="line">                        <span class="string">"challenge_training"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shrink_case</span><span class="params">(case)</span>:</span></span><br><span class="line">    toks = case.split(<span class="string">"-"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">shrink_if_number</span><span class="params">(x)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cvt = int(x)</span><br><span class="line">            <span class="keyword">return</span> str(cvt)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="keyword">return</span> x</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"-"</span>.join([shrink_if_number(t) <span class="keyword">for</span> t <span class="keyword">in</span> toks])</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Contour</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, ctr_path)</span>:</span></span><br><span class="line">        self.ctr_path = ctr_path</span><br><span class="line">        match = re.search(<span class="string">r"/([^/]*)/contours-manual/IRCCI-expert/IM-0001-(\d&#123;4&#125;)-icontour-manual.txt"</span>, ctr_path)</span><br><span class="line">        self.case = shrink_case(match.group(<span class="number">1</span>))</span><br><span class="line">        self.img_no = int(match.group(<span class="number">2</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;Contour for case %s, image %d&gt;"</span> % (self.case, self.img_no)</span><br><span class="line">    </span><br><span class="line">    __repr__ = __str__</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_contour</span><span class="params">(contour, img_path)</span>:</span></span><br><span class="line"></span><br><span class="line">    filename = <span class="string">"IM-%s-%04d.dcm"</span> % (SAX_SERIES[contour.case], contour.img_no)</span><br><span class="line">    full_path = os.path.join(img_path, contour.case, filename)</span><br><span class="line">    <span class="comment">#print full_path</span></span><br><span class="line">    f = dicom.read_file(full_path)</span><br><span class="line">    img = f.pixel_array.astype(np.int)</span><br><span class="line">    ctrs = np.loadtxt(contour.ctr_path, delimiter=<span class="string">" "</span>).astype(np.int)</span><br><span class="line">    label = np.zeros_like(img, dtype=<span class="string">"uint8"</span>)</span><br><span class="line"></span><br><span class="line">    cv2.fillPoly(label, [ctrs], <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> img, label</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_all_contours</span><span class="params">(contour_path)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> contour_path</span><br><span class="line">    contours = [os.path.join(dirpath, f)</span><br><span class="line">        <span class="keyword">for</span> dirpath, dirnames, files <span class="keyword">in</span> os.walk(contour_path)</span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> fnmatch.filter(files, <span class="string">'IM-0001-*-icontour-manual.txt'</span>)]</span><br><span class="line">    print(<span class="string">"Shuffle data"</span>)</span><br><span class="line">    np.random.shuffle(contours)</span><br><span class="line">    print(<span class="string">"Number of examples: &#123;:d&#125;"</span>.format(len(contours)))</span><br><span class="line">    extracted = map(Contour, contours)</span><br><span class="line">    <span class="keyword">return</span> extracted</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">export_all_contours</span><span class="params">(contours, img_path, lmdb_img_name, lmdb_label_name)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> lmdb_name <span class="keyword">in</span> [lmdb_img_name, lmdb_label_name]:</span><br><span class="line">        db_path = os.path.abspath(lmdb_name)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(db_path):</span><br><span class="line">            shutil.rmtree(db_path)</span><br><span class="line">    counter_img = <span class="number">0</span></span><br><span class="line">    counter_label = <span class="number">0</span></span><br><span class="line">    batchsz = <span class="number">100</span></span><br><span class="line">    print(<span class="string">"Processing &#123;:d&#125; images and labels..."</span>.format(len(contours)))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(int(np.ceil(len(contours) / float(batchsz)))):</span><br><span class="line">        batch = contours[(batchsz*i):(batchsz*(i+<span class="number">1</span>))]</span><br><span class="line">        <span class="keyword">if</span> len(batch) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        imgs, labels = [], []</span><br><span class="line">        <span class="keyword">for</span> idx,ctr <span class="keyword">in</span> enumerate(batch):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                img, label = load_contour(ctr, img_path)</span><br><span class="line">                imgs.append(img)</span><br><span class="line">                labels.append(label)</span><br><span class="line">                <span class="keyword">if</span> idx % <span class="number">20</span> == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">print</span> ctr</span><br><span class="line">                    plt.imshow(img)</span><br><span class="line">                    plt.show()</span><br><span class="line">                    plt.imshow(label)</span><br><span class="line">                    plt.show()</span><br><span class="line">            <span class="keyword">except</span> IOError:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        db_imgs = lmdb.open(lmdb_img_name, map_size=<span class="number">1e12</span>)</span><br><span class="line">        <span class="keyword">with</span> db_imgs.begin(write=<span class="keyword">True</span>) <span class="keyword">as</span> txn_img:</span><br><span class="line">            <span class="keyword">for</span> img <span class="keyword">in</span> imgs:</span><br><span class="line">                datum = caffe.io.array_to_datum(np.expand_dims(img, axis=<span class="number">0</span>))</span><br><span class="line">                txn_img.put(<span class="string">"&#123;:0&gt;10d&#125;"</span>.format(counter_img), datum.SerializeToString())</span><br><span class="line">                counter_img += <span class="number">1</span></span><br><span class="line">        print(<span class="string">"Processed &#123;:d&#125; images"</span>.format(counter_img))</span><br><span class="line">        db_labels = lmdb.open(lmdb_label_name, map_size=<span class="number">1e12</span>)</span><br><span class="line">        <span class="keyword">with</span> db_labels.begin(write=<span class="keyword">True</span>) <span class="keyword">as</span> txn_label:</span><br><span class="line">            <span class="keyword">for</span> lbl <span class="keyword">in</span> labels:</span><br><span class="line">                datum = caffe.io.array_to_datum(np.expand_dims(lbl, axis=<span class="number">0</span>))</span><br><span class="line">                txn_label.put(<span class="string">"&#123;:0&gt;10d&#125;"</span>.format(counter_label), datum.SerializeToString())</span><br><span class="line">                counter_label += <span class="number">1</span></span><br><span class="line">        print(<span class="string">"Processed &#123;:d&#125; labels"</span>.format(counter_label))</span><br><span class="line">    db_imgs.close()</span><br><span class="line">    db_labels.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__== <span class="string">"__main__"</span>:</span><br><span class="line">    SPLIT_RATIO = <span class="number">0.1</span></span><br><span class="line">    print(<span class="string">"Mapping ground truth contours to images..."</span>)</span><br><span class="line">    ctrs = get_all_contours(TRAIN_CONTOUR_PATH)</span><br><span class="line">    val_ctrs = ctrs[<span class="number">0</span>:int(SPLIT_RATIO*len(ctrs))]</span><br><span class="line">    train_ctrs = ctrs[int(SPLIT_RATIO*len(ctrs)):]</span><br><span class="line">    print(<span class="string">"Done mapping ground truth contours to images"</span>)</span><br><span class="line">    print(<span class="string">"\nBuilding LMDB for train..."</span>)</span><br><span class="line">    export_all_contours(train_ctrs, TRAIN_IMG_PATH, <span class="string">"train_images_lmdb"</span>, <span class="string">"train_labels_lmdb"</span>)</span><br><span class="line">    print(<span class="string">"\nBuilding LMDB for val..."</span>)</span><br><span class="line">    export_all_contours(val_ctrs, TRAIN_IMG_PATH, <span class="string">"val_images_lmdb"</span>, <span class="string">"val_labels_lmdb"</span>)</span><br></pre></td></tr></table></figure></p>
<p>运行这段代码的时候遇到以下错误：</p>
<ul>
<li>解压数据的时候多了一层目录，比如应该是sunnybrook_data/challenge_training/xxx，然而解压完后变成sunnybrook_data/challenge_training／challenge_training/xxx，因此出错</li>
</ul>
<p>###Step 2: Instantiate and solve a Caffe FCN model<br>以下代码使用python 调用caffe的API来定义FCN网络，过程与<a href="https://github.com/BVLC/caffe/blob/master/examples/01-learning-lenet.ipynb" target="_blank" rel="external">https://github.com/BVLC/caffe/blob/master/examples/01-learning-lenet.ipynb</a> 类似,这段代码会自动生成fcn_train.prototxt and fcn_test.prototxt：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> caffe <span class="keyword">import</span> layers <span class="keyword">as</span> L</span><br><span class="line"><span class="keyword">from</span> caffe <span class="keyword">import</span> params <span class="keyword">as</span> P</span><br><span class="line"></span><br><span class="line">n = caffe.NetSpec()</span><br><span class="line"></span><br><span class="line"><span class="comment"># helper functions for common structures</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv_relu</span><span class="params">(bottom, ks, nout, weight_init=<span class="string">'gaussian'</span>, weight_std=<span class="number">0.01</span>, bias_value=<span class="number">0</span>, mult=<span class="number">1</span>, stride=<span class="number">1</span>, pad=<span class="number">0</span>, group=<span class="number">1</span>)</span>:</span></span><br><span class="line">    conv = L.Convolution(bottom, kernel_size=ks, stride=stride,</span><br><span class="line">                         num_output=nout, pad=pad, group=group,</span><br><span class="line">                         weight_filler=dict(type=weight_init, mean=<span class="number">0.0</span>, std=weight_std),</span><br><span class="line">                         bias_filler=dict(type=<span class="string">'constant'</span>, value=bias_value),</span><br><span class="line">                         param=[dict(lr_mult=mult, decay_mult=mult), dict(lr_mult=<span class="number">2</span>*mult, decay_mult=<span class="number">0</span>*mult)])</span><br><span class="line">    <span class="keyword">return</span> conv, L.ReLU(conv, in_place=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">max_pool</span><span class="params">(bottom, ks, stride=<span class="number">1</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> L.Pooling(bottom, pool=P.Pooling.MAX, kernel_size=ks, stride=stride)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">FCN</span><span class="params">(images_lmdb, labels_lmdb, batch_size, include_acc=False)</span>:</span></span><br><span class="line">    <span class="comment"># net definition</span></span><br><span class="line">    n.data = L.Data(source=images_lmdb, backend=P.Data.LMDB, batch_size=batch_size, ntop=<span class="number">1</span>,</span><br><span class="line">                    transform_param=dict(crop_size=<span class="number">0</span>, mean_value=[<span class="number">77</span>], mirror=<span class="keyword">False</span>))</span><br><span class="line">    n.label = L.Data(source=labels_lmdb, backend=P.Data.LMDB, batch_size=batch_size, ntop=<span class="number">1</span>)</span><br><span class="line">    n.conv1, n.relu1 = conv_relu(n.data, ks=<span class="number">5</span>, nout=<span class="number">100</span>, stride=<span class="number">2</span>, pad=<span class="number">50</span>, bias_value=<span class="number">0.1</span>)</span><br><span class="line">    n.pool1 = max_pool(n.relu1, ks=<span class="number">2</span>, stride=<span class="number">2</span>)</span><br><span class="line">    n.conv2, n.relu2 = conv_relu(n.pool1, ks=<span class="number">5</span>, nout=<span class="number">200</span>, stride=<span class="number">2</span>, bias_value=<span class="number">0.1</span>)</span><br><span class="line">    n.pool2 = max_pool(n.relu2, ks=<span class="number">2</span>, stride=<span class="number">2</span>)</span><br><span class="line">    n.conv3, n.relu3 = conv_relu(n.pool2, ks=<span class="number">3</span>, nout=<span class="number">300</span>, stride=<span class="number">1</span>, bias_value=<span class="number">0.1</span>)</span><br><span class="line">    n.conv4, n.relu4 = conv_relu(n.relu3, ks=<span class="number">3</span>, nout=<span class="number">300</span>, stride=<span class="number">1</span>, bias_value=<span class="number">0.1</span>)</span><br><span class="line">    n.drop = L.Dropout(n.relu4, dropout_ratio=<span class="number">0.1</span>, in_place=<span class="keyword">True</span>)</span><br><span class="line">    n.score_classes, _= conv_relu(n.drop, ks=<span class="number">1</span>, nout=<span class="number">2</span>, weight_std=<span class="number">0.01</span>, bias_value=<span class="number">0.1</span>)</span><br><span class="line">    n.upscore = L.Deconvolution(n.score_classes)</span><br><span class="line">    n.score = L.Crop(n.upscore,n.data)</span><br><span class="line">    n.loss = L.SoftmaxWithLoss(n.score, n.label, loss_param=dict(normalize=<span class="keyword">True</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> include_acc:</span><br><span class="line">        n.accuracy = L.Accuracy(n.score, n.label)</span><br><span class="line">        <span class="keyword">return</span> n.to_proto()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> n.to_proto()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_nets</span><span class="params">()</span>:</span></span><br><span class="line">    header = <span class="string">'name: "FCN"\nforce_backward: true\n'</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'fcn_train.prototxt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(header + str(FCN(<span class="string">'train_images_lmdb/'</span>, <span class="string">'train_labels_lmdb/'</span>, batch_size=<span class="number">1</span>, include_acc=<span class="keyword">False</span>)))</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'fcn_test.prototxt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(header + str(FCN(<span class="string">'val_images_lmdb/'</span>, <span class="string">'val_labels_lmdb/'</span>, batch_size=<span class="number">1</span>, include_acc=<span class="keyword">True</span>)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    make_nets()</span><br></pre></td></tr></table></figure></p>
<p>由于现在还不是正式版本的caffe，所以这里的Deconvolution要自己手动修改，将其中的train和test中的Deconvolution改为以下代码：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">layer</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">name</span>:<span class="value"> <span class="string">"upscore"</span></span><br><span class="line">  type: <span class="string">"Deconvolution"</span></span><br><span class="line">  bottom: <span class="string">"score_classes"</span></span><br><span class="line">  top: <span class="string">"upscore"</span></span><br><span class="line">  param &#123;</span><br><span class="line">    lr_mult: <span class="number">1</span></span><br><span class="line">    decay_mult: <span class="number">1</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">  <span class="tag">param</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">lr_mult</span>:<span class="value"> <span class="number">2</span></span><br><span class="line">    decay_mult: <span class="number">0</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">  <span class="tag">convolution_param</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">num_output</span>:<span class="value"> <span class="number">2</span></span><br><span class="line">    bias_term: true</span><br><span class="line">    kernel_size: <span class="number">31</span></span><br><span class="line">    pad: <span class="number">8</span></span><br><span class="line">    stride: <span class="number">16</span></span><br><span class="line">    weight_filler &#123; type: <span class="string">"bilinear"</span> </span></span></span>&#125;</span><br><span class="line">    <span class="tag">bias_filler</span> <span class="rules">&#123; <span class="rule"><span class="attribute">type</span>:<span class="value"> <span class="string">"constant"</span> value: <span class="number">0.1</span> </span></span></span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着手动创建fcn_solver.prototxt，内容如下：<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="preprocessor"># The train/test net protocol buffers definition</span></span><br><span class="line"><span class="label">train_net:</span> <span class="string">"fcn_train.prototxt"</span></span><br><span class="line"><span class="label">test_net:</span> <span class="string">"fcn_test.prototxt"</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># test_iter specifies how many forward passes the test should carry out.</span></span><br><span class="line"><span class="preprocessor"># In our case, we have test batch size 1 and 26 test iterations,</span></span><br><span class="line"><span class="preprocessor"># covering the full size of testing images.</span></span><br><span class="line"><span class="label">test_iter:</span> <span class="number">26</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># Carry out testing every 200 training iterations.</span></span><br><span class="line"><span class="label">test_interval:</span> <span class="number">200</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># display interval</span></span><br><span class="line"><span class="label">display:</span> <span class="number">200</span></span><br><span class="line"><span class="label">average_loss:</span> <span class="number">200</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># The learning rate policy</span></span><br><span class="line"><span class="label">lr_policy:</span> <span class="string">"multistep"</span></span><br><span class="line"><span class="label">stepvalue:</span> <span class="number">10000</span></span><br><span class="line"><span class="label">gamma:</span> <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># The base learning rate, momentum and the weight decay of the network.</span></span><br><span class="line"><span class="label">base_lr:</span> <span class="number">0.01</span></span><br><span class="line"><span class="label">momentum:</span> <span class="number">0.9</span></span><br><span class="line"><span class="label">weight_decay:</span> <span class="number">0.0005</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># The maximum number of iterations</span></span><br><span class="line"><span class="label">max_iter:</span> <span class="number">15000</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># snapshot intervals to disk</span></span><br><span class="line"><span class="label">snapshot:</span> <span class="number">2500</span></span><br><span class="line"><span class="label">snapshot_prefix:</span> <span class="string">"./model_logs/fcn"</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># misc settings</span></span><br><span class="line"><span class="label">test_initialization:</span> true</span><br><span class="line"><span class="label">random_seed:</span> <span class="number">5</span></span><br><span class="line"><span class="preprocessor">#solver_type: NESTEROV</span></span><br></pre></td></tr></table></figure></p>
<p>然后用caffe提供的SGDSolver进行训练<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">caffe.set_mode_gpu() <span class="comment"># or caffe.set_mode_cpu() for machines without a GPU</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">del</span> solver <span class="comment"># it is a good idea to delete the solver object to free up memory before instantiating another one</span></span><br><span class="line">    solver = caffe.SGDSolver(<span class="string">'fcn_solver.prototxt'</span>)</span><br><span class="line"><span class="keyword">except</span> NameError:</span><br><span class="line">    solver = caffe.SGDSolver(<span class="string">'fcn_solver.prototxt'</span>)</span><br></pre></td></tr></table></figure></p>
<p>根据caffe文档的描述：</p>
<blockquote>
<p>A blob is an N-dimensional array stored in a C-contiguous fashion. Caffe stores and communicates data using blobs. Blobs provide a unified memory interface holding data; e.g., batches of images, model parameters, and derivatives for optimization. The conventional blob dimensions for batches of image data are number N x channel K x height H x width W.</p>
</blockquote>
<p>所以我们的data blob维度是1x1x256x256<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># each blob has dimensions batch_size x channel_dim x height x width</span></span><br><span class="line">[(k, v.data.shape) <span class="keyword">for</span> k,v <span class="keyword">in</span> solver.net.blobs.items()]</span><br></pre></td></tr></table></figure></p>
<p>接下来我们检测blob的参数，也就是模型的权重，拥有可学习的参数的层都有weight_filler配置，并且需要初始化而且在训练过程中要通过梯度下降法进行更新。每个blob的参数集合更新都有一个对应的维度相同的diff　blob集合。diff blob存储对应层的反向传播计算的损失函数的梯度，访问diff blob有两个目的：</p>
<ul>
<li>model debugging and diagnosis . a model with zero diffs does not compute gradients and hence does not learn anything, which may indicate a vanishing-gradient problem; </li>
<li>visualization of class saliency maps for input images, as suggested in the paper<a href="http://arxiv.org/pdf/1312.6034.pdf" target="_blank" rel="external">Deep Inside Convolutional Networks: Visualising Image Classification Models and Saliency Maps</a><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># print the layers with learnable weights and their dimensions</span></span><br><span class="line">[(k, v[<span class="number">0</span>].data.shape) <span class="keyword">for</span> k, v <span class="keyword">in</span> solver.net.params.items()]</span><br><span class="line"><span class="comment">#######################</span></span><br><span class="line"><span class="comment"># print the biases associated with the weights</span></span><br><span class="line">[(k, v[<span class="number">1</span>].data.shape) <span class="keyword">for</span> k, v <span class="keyword">in</span> solver.net.params.items()]</span><br><span class="line"><span class="comment"># params and diffs have the same dimensions</span></span><br><span class="line">[(k, v[<span class="number">0</span>].diff.shape) <span class="keyword">for</span> k, v <span class="keyword">in</span> solver.net.params.items()]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>开始训练之前先验证梯度能正确传递并且能更新权值<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># forward pass with randomly initialized weights</span></span><br><span class="line">solver.net.forward()  <span class="comment"># train net</span></span><br><span class="line">solver.test_nets[<span class="number">0</span>].forward()  <span class="comment"># test net (more than one net is supported)</span></span><br><span class="line"><span class="comment"># visualize the image data and its correpsonding label from the train net</span></span><br><span class="line">img_train = solver.net.blobs[<span class="string">'data'</span>].data[<span class="number">0</span>,<span class="number">0</span>,...]</span><br><span class="line">plt.imshow(img_train)</span><br><span class="line">plt.show()</span><br><span class="line">label_train = solver.net.blobs[<span class="string">'label'</span>].data[<span class="number">0</span>,<span class="number">0</span>,...]</span><br><span class="line">plt.imshow(label_train)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># visualize the image data and its correpsonding label from the test net</span></span><br><span class="line">img_test = solver.test_nets[<span class="number">0</span>].blobs[<span class="string">'data'</span>].data[<span class="number">0</span>,<span class="number">0</span>,...]</span><br><span class="line">plt.imshow(img_test)</span><br><span class="line">plt.show()</span><br><span class="line">label_test = solver.test_nets[<span class="number">0</span>].blobs[<span class="string">'label'</span>].data[<span class="number">0</span>,<span class="number">0</span>,...]</span><br><span class="line">plt.imshow(label_test)</span><br><span class="line">plt.show()</span><br><span class="line"><span class="comment"># take one step of stochastic gradient descent consisting of both forward pass and backprop</span></span><br><span class="line">solver.step(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># visualize gradients after backprop. If non-zero, then gradients are properly propagating and the nets are learning something</span></span><br><span class="line"><span class="comment"># gradients are shown here as 10 x 10 grid of 5 x 5 filters</span></span><br><span class="line">plt.imshow(solver.net.params[<span class="string">'conv1'</span>][<span class="number">0</span>].diff[:,<span class="number">0</span>,...].reshape(<span class="number">10</span>,<span class="number">10</span>,<span class="number">5</span>,<span class="number">5</span>).transpose(<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>).reshape(<span class="number">10</span>*<span class="number">5</span>,<span class="number">10</span>*<span class="number">5</span>), <span class="string">'gray'</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p>
<p>现在开始训练模型：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%%time</span><br><span class="line">ret = subprocess.call(os.path.join(CAFFE_ROOT, <span class="string">'build/tools/caffe'</span>) + <span class="string">' '</span> + <span class="string">'train -solver=fcn_solver.prototxt -gpu 0 2&gt; fcn_train.log'</span>, shell=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure></p>
<p>教程这里用的是二元精度，这实际上是一种误导，因为对于LV分割问题，每个像素都属于一个label：0 for background and 1 for LV。但是在整个图像中属于lV部分的像素不到2%，所以这是一个class imbalance问题。where the class distribution is highly skewed and binary accuracy is not a meaningful performance metric. Suppose a model simply predicts all pixels to be background, then its accuracy performance is still greater than 0.98, even though the model is not able to actually detect pixels belonging to the LV object. The reader is encouraged to consider the following alternative performance metrics for LV segmentation: <a href="https://en.wikipedia.org/wiki/S%C3%B8rensen%E2%80%93Dice_coefficient" target="_blank" rel="external">Sørensen–Dice index</a> and <a href="http://smial.sri.utoronto.ca/LV_Challenge/Evaluation.html" target="_blank" rel="external">average perpendicular distance</a>.</p>
<h2 id="Step_3_3A_Apply_trained_Caffe_FCN_model_to_compute_EF"><a href="#Step_3_3A_Apply_trained_Caffe_FCN_model_to_compute_EF" class="headerlink" title="Step 3: Apply trained Caffe FCN model to compute EF"></a>Step 3: Apply trained Caffe FCN model to compute EF</h2><p>这部分内容是关于如何将我们在Sunnybrook数据集上训练的模型应用到DSB数据集上去做LV 分割。先创建文件fcn_deploy.prototxt，该文件与fcn_train.prototxt文件类似，不过要去掉data layers并且将SoftmaxWithLoss layer 替换为 the Softmax layer</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">name</span>: "<span class="tag">FCN</span>"</span><br><span class="line"><span class="tag">force_backward</span>: <span class="tag">true</span></span><br><span class="line"><span class="tag">input</span>: "<span class="tag">data</span>"</span><br><span class="line"># <span class="tag">We</span> <span class="tag">will</span> <span class="tag">manipulate</span> <span class="tag">the</span> <span class="tag">input_dim</span> <span class="tag">fields</span> <span class="tag">below</span> <span class="tag">in</span> <span class="tag">Python</span> <span class="tag">during</span> <span class="tag">testing</span>. <span class="tag">They</span> <span class="tag">appear</span> <span class="tag">here</span> <span class="tag">only</span> <span class="tag">for</span> <span class="tag">syntactic</span> <span class="tag">reasons</span>.</span><br><span class="line"><span class="tag">input_dim</span>: 1</span><br><span class="line"><span class="tag">input_dim</span>: 1</span><br><span class="line"><span class="tag">input_dim</span>: 1</span><br><span class="line"><span class="tag">input_dim</span>: 1</span><br><span class="line"><span class="tag">layer</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">name</span>:<span class="value"> <span class="string">"conv1"</span></span><br><span class="line">  type: <span class="string">"Convolution"</span></span><br><span class="line">  bottom: <span class="string">"data"</span></span><br><span class="line">  top: <span class="string">"conv1"</span></span><br><span class="line">  param &#123;</span><br><span class="line">    lr_mult: <span class="number">1</span></span><br><span class="line">    decay_mult: <span class="number">1</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">  <span class="tag">param</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">lr_mult</span>:<span class="value"> <span class="number">2</span></span><br><span class="line">    decay_mult: <span class="number">0</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">  <span class="tag">convolution_param</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">num_output</span>:<span class="value"> <span class="number">100</span></span><br><span class="line">    pad: <span class="number">50</span></span><br><span class="line">    kernel_size: <span class="number">5</span></span><br><span class="line">    group: <span class="number">1</span></span><br><span class="line">    stride: <span class="number">2</span></span><br><span class="line">    weight_filler &#123;</span><br><span class="line">      type: <span class="string">"gaussian"</span></span><br><span class="line">      mean: <span class="number">0.0</span></span><br><span class="line">      std: <span class="number">0.01</span></span><br><span class="line">    </span></span></span>&#125;</span><br><span class="line">    <span class="tag">bias_filler</span> <span class="rules">&#123;</span><br><span class="line">      <span class="rule"><span class="attribute">type</span>:<span class="value"> <span class="string">"constant"</span></span><br><span class="line">      value: <span class="number">0.1</span></span><br><span class="line">    </span></span></span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">layer</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">name</span>:<span class="value"> <span class="string">"relu1"</span></span><br><span class="line">  type: <span class="string">"ReLU"</span></span><br><span class="line">  bottom: <span class="string">"conv1"</span></span><br><span class="line">  top: <span class="string">"conv1"</span></span><br><span class="line"></span></span></span>&#125;</span><br><span class="line"><span class="tag">layer</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">name</span>:<span class="value"> <span class="string">"pool1"</span></span><br><span class="line">  type: <span class="string">"Pooling"</span></span><br><span class="line">  bottom: <span class="string">"conv1"</span></span><br><span class="line">  top: <span class="string">"pool1"</span></span><br><span class="line">  pooling_param &#123;</span><br><span class="line">    pool: MAX</span><br><span class="line">    kernel_size: <span class="number">2</span></span><br><span class="line">    stride: <span class="number">2</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">layer</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">name</span>:<span class="value"> <span class="string">"conv2"</span></span><br><span class="line">  type: <span class="string">"Convolution"</span></span><br><span class="line">  bottom: <span class="string">"pool1"</span></span><br><span class="line">  top: <span class="string">"conv2"</span></span><br><span class="line">  param &#123;</span><br><span class="line">    lr_mult: <span class="number">1</span></span><br><span class="line">    decay_mult: <span class="number">1</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">  <span class="tag">param</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">lr_mult</span>:<span class="value"> <span class="number">2</span></span><br><span class="line">    decay_mult: <span class="number">0</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">  <span class="tag">convolution_param</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">num_output</span>:<span class="value"> <span class="number">200</span></span><br><span class="line">    pad: <span class="number">0</span></span><br><span class="line">    kernel_size: <span class="number">5</span></span><br><span class="line">    group: <span class="number">1</span></span><br><span class="line">    stride: <span class="number">2</span></span><br><span class="line">    weight_filler &#123;</span><br><span class="line">      type: <span class="string">"gaussian"</span></span><br><span class="line">      mean: <span class="number">0.0</span></span><br><span class="line">      std: <span class="number">0.01</span></span><br><span class="line">    </span></span></span>&#125;</span><br><span class="line">    <span class="tag">bias_filler</span> <span class="rules">&#123;</span><br><span class="line">      <span class="rule"><span class="attribute">type</span>:<span class="value"> <span class="string">"constant"</span></span><br><span class="line">      value: <span class="number">0.1</span></span><br><span class="line">    </span></span></span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">layer</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">name</span>:<span class="value"> <span class="string">"relu2"</span></span><br><span class="line">  type: <span class="string">"ReLU"</span></span><br><span class="line">  bottom: <span class="string">"conv2"</span></span><br><span class="line">  top: <span class="string">"conv2"</span></span><br><span class="line"></span></span></span>&#125;</span><br><span class="line"><span class="tag">layer</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">name</span>:<span class="value"> <span class="string">"pool2"</span></span><br><span class="line">  type: <span class="string">"Pooling"</span></span><br><span class="line">  bottom: <span class="string">"conv2"</span></span><br><span class="line">  top: <span class="string">"pool2"</span></span><br><span class="line">  pooling_param &#123;</span><br><span class="line">    pool: MAX</span><br><span class="line">    kernel_size: <span class="number">2</span></span><br><span class="line">    stride: <span class="number">2</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">layer</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">name</span>:<span class="value"> <span class="string">"conv3"</span></span><br><span class="line">  type: <span class="string">"Convolution"</span></span><br><span class="line">  bottom: <span class="string">"pool2"</span></span><br><span class="line">  top: <span class="string">"conv3"</span></span><br><span class="line">  param &#123;</span><br><span class="line">    lr_mult: <span class="number">1</span></span><br><span class="line">    decay_mult: <span class="number">1</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">  <span class="tag">param</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">lr_mult</span>:<span class="value"> <span class="number">2</span></span><br><span class="line">    decay_mult: <span class="number">0</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">  <span class="tag">convolution_param</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">num_output</span>:<span class="value"> <span class="number">300</span></span><br><span class="line">    pad: <span class="number">0</span></span><br><span class="line">    kernel_size: <span class="number">3</span></span><br><span class="line">    group: <span class="number">1</span></span><br><span class="line">    stride: <span class="number">1</span></span><br><span class="line">    weight_filler &#123;</span><br><span class="line">      type: <span class="string">"gaussian"</span></span><br><span class="line">      mean: <span class="number">0.0</span></span><br><span class="line">      std: <span class="number">0.01</span></span><br><span class="line">    </span></span></span>&#125;</span><br><span class="line">    <span class="tag">bias_filler</span> <span class="rules">&#123;</span><br><span class="line">      <span class="rule"><span class="attribute">type</span>:<span class="value"> <span class="string">"constant"</span></span><br><span class="line">      value: <span class="number">0.1</span></span><br><span class="line">    </span></span></span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">layer</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">name</span>:<span class="value"> <span class="string">"relu3"</span></span><br><span class="line">  type: <span class="string">"ReLU"</span></span><br><span class="line">  bottom: <span class="string">"conv3"</span></span><br><span class="line">  top: <span class="string">"conv3"</span></span><br><span class="line"></span></span></span>&#125;</span><br><span class="line"><span class="tag">layer</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">name</span>:<span class="value"> <span class="string">"conv4"</span></span><br><span class="line">  type: <span class="string">"Convolution"</span></span><br><span class="line">  bottom: <span class="string">"conv3"</span></span><br><span class="line">  top: <span class="string">"conv4"</span></span><br><span class="line">  param &#123;</span><br><span class="line">    lr_mult: <span class="number">1</span></span><br><span class="line">    decay_mult: <span class="number">1</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">  <span class="tag">param</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">lr_mult</span>:<span class="value"> <span class="number">2</span></span><br><span class="line">    decay_mult: <span class="number">0</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">  <span class="tag">convolution_param</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">num_output</span>:<span class="value"> <span class="number">300</span></span><br><span class="line">    pad: <span class="number">0</span></span><br><span class="line">    kernel_size: <span class="number">3</span></span><br><span class="line">    group: <span class="number">1</span></span><br><span class="line">    stride: <span class="number">1</span></span><br><span class="line">    weight_filler &#123;</span><br><span class="line">      type: <span class="string">"gaussian"</span></span><br><span class="line">      mean: <span class="number">0.0</span></span><br><span class="line">      std: <span class="number">0.01</span></span><br><span class="line">    </span></span></span>&#125;</span><br><span class="line">    <span class="tag">bias_filler</span> <span class="rules">&#123;</span><br><span class="line">      <span class="rule"><span class="attribute">type</span>:<span class="value"> <span class="string">"constant"</span></span><br><span class="line">      value: <span class="number">0.1</span></span><br><span class="line">    </span></span></span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">layer</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">name</span>:<span class="value"> <span class="string">"relu4"</span></span><br><span class="line">  type: <span class="string">"ReLU"</span></span><br><span class="line">  bottom: <span class="string">"conv4"</span></span><br><span class="line">  top: <span class="string">"conv4"</span></span><br><span class="line"></span></span></span>&#125;</span><br><span class="line"><span class="tag">layer</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">name</span>:<span class="value"> <span class="string">"drop"</span></span><br><span class="line">  type: <span class="string">"Dropout"</span></span><br><span class="line">  bottom: <span class="string">"conv4"</span></span><br><span class="line">  top: <span class="string">"conv4"</span></span><br><span class="line">  dropout_param &#123;</span><br><span class="line">    dropout_ratio: <span class="number">0.1</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">layer</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">name</span>:<span class="value"> <span class="string">"score_classes"</span></span><br><span class="line">  type: <span class="string">"Convolution"</span></span><br><span class="line">  bottom: <span class="string">"conv4"</span></span><br><span class="line">  top: <span class="string">"score_classes"</span></span><br><span class="line">  param &#123;</span><br><span class="line">    lr_mult: <span class="number">1</span></span><br><span class="line">    decay_mult: <span class="number">1</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">  <span class="tag">param</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">lr_mult</span>:<span class="value"> <span class="number">2</span></span><br><span class="line">    decay_mult: <span class="number">0</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">  <span class="tag">convolution_param</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">num_output</span>:<span class="value"> <span class="number">2</span></span><br><span class="line">    pad: <span class="number">0</span></span><br><span class="line">    kernel_size: <span class="number">1</span></span><br><span class="line">    group: <span class="number">1</span></span><br><span class="line">    stride: <span class="number">1</span></span><br><span class="line">    weight_filler &#123;</span><br><span class="line">      type: <span class="string">"gaussian"</span></span><br><span class="line">      mean: <span class="number">0.0</span></span><br><span class="line">      std: <span class="number">0.01</span></span><br><span class="line">    </span></span></span>&#125;</span><br><span class="line">    <span class="tag">bias_filler</span> <span class="rules">&#123;</span><br><span class="line">      <span class="rule"><span class="attribute">type</span>:<span class="value"> <span class="string">"constant"</span></span><br><span class="line">      value: <span class="number">0.1</span></span><br><span class="line">    </span></span></span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">layer</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">name</span>:<span class="value"> <span class="string">"upscore"</span></span><br><span class="line">  type: <span class="string">"Deconvolution"</span></span><br><span class="line">  bottom: <span class="string">"score_classes"</span></span><br><span class="line">  top: <span class="string">"upscore"</span></span><br><span class="line">  param &#123;</span><br><span class="line">    lr_mult: <span class="number">1</span></span><br><span class="line">    decay_mult: <span class="number">1</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">  <span class="tag">param</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">lr_mult</span>:<span class="value"> <span class="number">2</span></span><br><span class="line">    decay_mult: <span class="number">0</span></span><br><span class="line">  </span></span></span>&#125;</span><br><span class="line">  <span class="tag">convolution_param</span> <span class="rules">&#123;</span><br><span class="line">    <span class="rule"><span class="attribute">num_output</span>:<span class="value"> <span class="number">2</span></span><br><span class="line">    bias_term: true</span><br><span class="line">    kernel_size: <span class="number">31</span></span><br><span class="line">    pad: <span class="number">8</span></span><br><span class="line">    stride: <span class="number">16</span></span><br><span class="line">    weight_filler &#123; type: <span class="string">"bilinear"</span> </span></span></span>&#125;</span><br><span class="line">    <span class="tag">bias_filler</span> <span class="rules">&#123; <span class="rule"><span class="attribute">type</span>:<span class="value"> <span class="string">"constant"</span> value: <span class="number">0.1</span> </span></span></span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">layer</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">name</span>:<span class="value"> <span class="string">"score"</span></span><br><span class="line">  type: <span class="string">"Crop"</span></span><br><span class="line">  bottom: <span class="string">"upscore"</span></span><br><span class="line">  bottom: <span class="string">"data"</span></span><br><span class="line">  top: <span class="string">"score"</span></span><br><span class="line"></span></span></span>&#125;</span><br><span class="line"><span class="tag">layer</span> <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">name</span>:<span class="value"> <span class="string">"prob"</span></span><br><span class="line">  type: <span class="string">"Softmax"</span></span><br><span class="line">  bottom: <span class="string">"score"</span></span><br><span class="line">  top: <span class="string">"prob"</span></span><br><span class="line"></span></span></span>&#125;</span><br></pre></td></tr></table></figure>
<p>我们用训练的fcn_iter_15000.caffemodel来进行LV segmentation和EF计算，Dataset类是将DICOM文件加载到内存方便后面使用<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dataset</span><span class="params">(object)</span>:</span></span><br><span class="line">    dataset_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, directory, subdir)</span>:</span></span><br><span class="line">        <span class="comment"># deal with any intervening directories</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            subdirs = next(os.walk(directory))[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> len(subdirs) == <span class="number">1</span>:</span><br><span class="line">                directory = os.path.join(directory, subdirs[<span class="number">0</span>])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        slices = []</span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> subdirs:</span><br><span class="line">            m = re.match(<span class="string">'sax_(\d+)'</span>, s)</span><br><span class="line">            <span class="keyword">if</span> m <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                slices.append(int(m.group(<span class="number">1</span>)))</span><br><span class="line"></span><br><span class="line">        slices_map = &#123;&#125;</span><br><span class="line">        first = <span class="keyword">True</span></span><br><span class="line">        times = []</span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> slices:</span><br><span class="line">            files = next(os.walk(os.path.join(directory, <span class="string">'sax_%d'</span> % s)))[<span class="number">2</span>]</span><br><span class="line">            offset = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> f <span class="keyword">in</span> files:</span><br><span class="line">                m = re.match(<span class="string">'IM-(\d&#123;4,&#125;)-(\d&#123;4&#125;)\.dcm'</span>, f)</span><br><span class="line">                <span class="keyword">if</span> m <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                    <span class="keyword">if</span> first:</span><br><span class="line">                        times.append(int(m.group(<span class="number">2</span>)))</span><br><span class="line">                    <span class="keyword">if</span> offset <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                        offset = int(m.group(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">            first = <span class="keyword">False</span></span><br><span class="line">            slices_map[s] = offset</span><br><span class="line"></span><br><span class="line">        self.directory = directory</span><br><span class="line">        self.time = sorted(times)</span><br><span class="line">        self.slices = sorted(slices)</span><br><span class="line">        self.slices_map = slices_map</span><br><span class="line">        Dataset.dataset_count += <span class="number">1</span></span><br><span class="line">        self.name = subdir</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_filename</span><span class="params">(self, s, t)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> os.path.join(self.directory,</span><br><span class="line">                            <span class="string">'sax_%d'</span> % s,</span><br><span class="line">                            <span class="string">'IM-%04d-%04d.dcm'</span> % (self.slices_map[s], t))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_read_dicom_image</span><span class="params">(self, filename)</span>:</span></span><br><span class="line">        d = dicom.read_file(filename)</span><br><span class="line">        img = d.pixel_array.astype(<span class="string">'int'</span>)</span><br><span class="line">        <span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_read_all_dicom_images</span><span class="params">(self)</span>:</span></span><br><span class="line">        f1 = self._filename(self.slices[<span class="number">0</span>], self.time[<span class="number">0</span>])</span><br><span class="line">        d1 = dicom.read_file(f1)</span><br><span class="line">        (x, y) = d1.PixelSpacing</span><br><span class="line">        (x, y) = (float(x), float(y))</span><br><span class="line">        f2 = self._filename(self.slices[<span class="number">1</span>], self.time[<span class="number">0</span>])</span><br><span class="line">        d2 = dicom.read_file(f2)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># try a couple of things to measure distance between slices</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            dist = np.abs(d2.SliceLocation - d1.SliceLocation)</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                dist = d1.SliceThickness</span><br><span class="line">            <span class="keyword">except</span> AttributeError:</span><br><span class="line">                dist = <span class="number">8</span>  <span class="comment"># better than nothing...</span></span><br><span class="line"></span><br><span class="line">        self.images = np.array([[self._read_dicom_image(self._filename(d, i))</span><br><span class="line">                                 <span class="keyword">for</span> i <span class="keyword">in</span> self.time]</span><br><span class="line">                                <span class="keyword">for</span> d <span class="keyword">in</span> self.slices])</span><br><span class="line">        self.dist = dist</span><br><span class="line">        self.area_multiplier = x * y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._read_all_dicom_images()</span><br></pre></td></tr></table></figure></p>
<p>以下两个为helper函数<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">MEAN_VALUE = <span class="number">77</span></span><br><span class="line">THRESH = <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc_all_areas</span><span class="params">(images)</span>:</span></span><br><span class="line">    (num_images, times, _, _) = images.shape</span><br><span class="line">    </span><br><span class="line">    all_masks = [&#123;&#125; <span class="keyword">for</span> i <span class="keyword">in</span> range(times)]</span><br><span class="line">    all_areas = [&#123;&#125; <span class="keyword">for</span> i <span class="keyword">in</span> range(times)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(times):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(num_images):</span><br><span class="line">            <span class="comment"># print 'Calculating area for time %d and slice %d...' % (i, j)</span></span><br><span class="line">            img = images[j][i]</span><br><span class="line">            in_ = np.expand_dims(img, axis=<span class="number">0</span>)</span><br><span class="line">            in_ -= np.array([MEAN_VALUE])</span><br><span class="line">            net.blobs[<span class="string">'data'</span>].reshape(<span class="number">1</span>, *in_.shape)</span><br><span class="line">            net.blobs[<span class="string">'data'</span>].data[...] = in_</span><br><span class="line">            net.forward()</span><br><span class="line">            prob = net.blobs[<span class="string">'prob'</span>].data</span><br><span class="line">            obj = prob[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">            preds = np.where(obj &gt; THRESH, <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">            all_masks[i][j] = preds</span><br><span class="line">            all_areas[i][j] = np.count_nonzero(preds)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> all_masks, all_areas</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc_total_volume</span><span class="params">(areas, area_multiplier, dist)</span>:</span></span><br><span class="line">    slices = np.array(sorted(areas.keys()))</span><br><span class="line">    modified = [areas[i] * area_multiplier <span class="keyword">for</span> i <span class="keyword">in</span> slices]</span><br><span class="line">    vol = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> slices[:-<span class="number">1</span>]:</span><br><span class="line">        a, b = modified[i], modified[i+<span class="number">1</span>]</span><br><span class="line">        subvol = (dist/<span class="number">3.0</span>) * (a + np.sqrt(a*b) + b)</span><br><span class="line">        vol += subvol / <span class="number">1000.0</span>  <span class="comment"># conversion to mL</span></span><br><span class="line">    <span class="keyword">return</span> vol</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">segment_dataset</span><span class="params">(dataset)</span>:</span></span><br><span class="line">    <span class="comment"># shape: num slices, num snapshots, rows, columns</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Calculating areas...'</span></span><br><span class="line">    all_masks, all_areas = calc_all_areas(dataset.images)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Calculating volumes...'</span></span><br><span class="line">    area_totals = [calc_total_volume(a, dataset.area_multiplier, dataset.dist)</span><br><span class="line">                   <span class="keyword">for</span> a <span class="keyword">in</span> all_areas]</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Calculating EF...'</span></span><br><span class="line">    edv = max(area_totals)</span><br><span class="line">    esv = min(area_totals)</span><br><span class="line">    ef = (edv - esv) / edv</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Done, EF is &#123;:0.4f&#125;'</span>.format(ef)</span><br><span class="line">    </span><br><span class="line">    dataset.edv = edv</span><br><span class="line">    dataset.esv = esv</span><br><span class="line">    dataset.ef = ef</span><br></pre></td></tr></table></figure></p>
<p>然后就可以进行计算<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">%%time</span><br><span class="line"><span class="comment"># We capture all standard output from IPython so it does not flood the interface.</span></span><br><span class="line"><span class="keyword">with</span> io.capture_output() <span class="keyword">as</span> captured:</span><br><span class="line">    <span class="comment"># edit this so it matches where you download the DSB data</span></span><br><span class="line">    DATA_PATH = <span class="string">'competition_data'</span></span><br><span class="line"></span><br><span class="line">    caffe.set_mode_gpu()</span><br><span class="line">    net = caffe.Net(<span class="string">'fcn_deploy.prototxt'</span>, <span class="string">'./model_logs/fcn_iter_15000.caffemodel'</span>, caffe.TEST)</span><br><span class="line"></span><br><span class="line">    train_dir = os.path.join(DATA_PATH, <span class="string">'train'</span>)</span><br><span class="line">    studies = next(os.walk(train_dir))[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    labels = np.loadtxt(os.path.join(DATA_PATH, <span class="string">'train.csv'</span>), delimiter=<span class="string">','</span>,</span><br><span class="line">                        skiprows=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    label_map = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> l <span class="keyword">in</span> labels:</span><br><span class="line">        label_map[l[<span class="number">0</span>]] = (l[<span class="number">2</span>], l[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(<span class="string">'output'</span>):</span><br><span class="line">        shutil.rmtree(<span class="string">'output'</span>)</span><br><span class="line">    os.mkdir(<span class="string">'output'</span>)</span><br><span class="line"></span><br><span class="line">    accuracy_csv = open(<span class="string">'accuracy.csv'</span>, <span class="string">'w'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> studies:</span><br><span class="line">        dset = Dataset(os.path.join(train_dir, s), s)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Processing dataset %s...'</span> % dset.name</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            dset.load()</span><br><span class="line">            segment_dataset(dset)</span><br><span class="line">            (edv, esv) = label_map[int(dset.name)]</span><br><span class="line">            accuracy_csv.write(<span class="string">'%s,%f,%f,%f,%f\n'</span> %</span><br><span class="line">                               (dset.name, edv, esv, dset.edv, dset.esv))</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'***ERROR***: Exception %s thrown by dataset %s'</span> % (str(e), dset.name)</span><br><span class="line"></span><br><span class="line">    accuracy_csv.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># We redirect the captured stdout to a log file on disk.</span></span><br><span class="line"><span class="comment"># This log file is very useful in identifying potential dataset irregularities that throw errors/exceptions in the code.</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'logs.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(captured.stdout)</span><br></pre></td></tr></table></figure></p>
<h2 id="Step_4_3A_Evaluate_performance"><a href="#Step_4_3A_Evaluate_performance" class="headerlink" title="Step 4: Evaluate performance"></a>Step 4: Evaluate performance</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># calculate some error metrics to evaluate actual vs. predicted EF values obtained from FCN model</span></span><br><span class="line">data = np.transpose(np.loadtxt(<span class="string">'accuracy.csv'</span>, delimiter=<span class="string">','</span>)).astype(<span class="string">'float'</span>)</span><br><span class="line">ids, actual_edv, actual_esv, predicted_edv, predicted_esv = data</span><br><span class="line">actual_ef = (actual_edv - actual_esv) / actual_edv</span><br><span class="line">actual_ef_std = np.std(actual_ef)</span><br><span class="line">actual_ef_median = np.median(actual_ef)</span><br><span class="line">predicted_ef = (predicted_edv - predicted_esv) / predicted_edv <span class="comment"># potential of dividing by zero, where there is no predicted EDV value</span></span><br><span class="line">nan_idx = np.isnan(predicted_ef)</span><br><span class="line">actual_ef = actual_ef[~nan_idx]</span><br><span class="line">predicted_ef = predicted_ef[~nan_idx]</span><br><span class="line">MAE = np.mean(np.abs(actual_ef - predicted_ef))</span><br><span class="line">RMSE = np.sqrt(np.mean((actual_ef - predicted_ef)**<span class="number">2</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">'Mean absolute error (MAE) for predicted EF: &#123;:0.4f&#125;'</span>.format(MAE)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'Root mean square error (RMSE) for predicted EF: &#123;:0.4f&#125;'</span>.format(RMSE)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'Standard deviation of actual EF: &#123;:0.4f&#125;'</span>.format(actual_ef_std)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'Median value of actual EF: &#123;:0.4f&#125;'</span>.format(actual_ef_median)</span><br></pre></td></tr></table></figure>
<h2 id="Some_ideas_for_improvement"><a href="#Some_ideas_for_improvement" class="headerlink" title="Some ideas for improvement"></a>Some ideas for improvement</h2><ul>
<li>通过增加网络的长度和宽度来扩大FCN</li>
<li>测试不同的学习率，权重初始化策略，solver type，kernel sizes, strides, dropout ratio, and other network hyper-parameters that could positively impact its learning performance.</li>
<li>尝试其他的非线性函数， leaky ReLUs, parametric ReLUs, or exponential linear units (ELUs).</li>
<li>Combine multiple models through bagging, boosting, stacking, and other methods in ensemble learning to improve predictive performance.</li>
<li>尝试其它的方法</li>
</ul>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>The following references on Caffe may be useful:<br>Deconvolution layer - <a href="https://github.com/BVLC/caffe/pull/1615" target="_blank" rel="external">https://github.com/BVLC/caffe/pull/1615</a><br>Crop layer - <a href="https://github.com/BVLC/caffe/pull/1976" target="_blank" rel="external">https://github.com/BVLC/caffe/pull/1976</a><br>Bilinear upsampling - <a href="https://github.com/BVLC/caffe/pull/2213" target="_blank" rel="external">https://github.com/BVLC/caffe/pull/2213</a><br>On-the-fly net resizing - <a href="https://github.com/BVLC/caffe/pull/594" target="_blank" rel="external">https://github.com/BVLC/caffe/pull/594</a><br>Main Caffe tutorial - <a href="http://caffe.berkeleyvision.org/tutorial/" target="_blank" rel="external">http://caffe.berkeleyvision.org/tutorial/</a><br>Caffe examples - <a href="http://caffe.berkeleyvision.org/" target="_blank" rel="external">http://caffe.berkeleyvision.org/</a><br>Caffe net specification - <a href="https://github.com/BVLC/caffe/blob/master/src/caffe/proto/caffe.proto" target="_blank" rel="external">https://github.com/BVLC/caffe/blob/master/src/caffe/proto/caffe.proto</a><br>Caffe users group - <a href="https://groups.google.com/forum/#!forum/caffe-users" target="_blank" rel="external">https://groups.google.com/forum/#!forum/caffe-users</a><br>Caffe GitHub page - <a href="https://github.com/BVLC/caffe" target="_blank" rel="external">https://github.com/BVLC/caffe</a></p>
<p>原文链接：<a href="https://www.kaggle.com/c/second-annual-data-science-bowl/details/deep-learning-tutorial" target="_blank" rel="external">https://www.kaggle.com/c/second-annual-data-science-bowl/details/deep-learning-tutorial</a></p>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/FCN/" rel="tag">#FCN</a>
          
            <a href="/tags/Segmentation/" rel="tag">#Segmentation</a>
          
            <a href="/tags/deep-learning/" rel="tag">#deep learning</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/12/21/Deep-learning论文笔记三：Fully-Convolutional-Networks-for-Semantic-Segmentation/" rel="next" title="Deep learning论文笔记三：Fully Convolutional Networks for Semantic Segmentation">
                <i class="fa fa-chevron-left"></i> Deep learning论文笔记三：Fully Convolutional Networks for Semantic Segmentation
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/01/22/Deep learning论文笔记四： SegNet：A deep convolutional encoder-decoder architecture for image Segmentaion/" rel="prev" title="Deep learning论文笔记四： SegNet：A deep convolutional encoder-decoder architecture for image Segmentaion">
                Deep learning论文笔记四： SegNet：A deep convolutional encoder-decoder architecture for image Segmentaion <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


        </div>

        

  <p>热评文章</p>
  <div class="ds-top-threads" data-range="weekly" data-num-items="4"></div>


        
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    
  </div>


      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="https://avatars1.githubusercontent.com/u/32269?v=3&s=460" alt="Ma Shuai" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Ma Shuai</p>
        </div>
        <p class="site-description motion-element" itemprop="description">专注于深度学习</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">8</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">4</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ma123shuai" target="_blank">
                  
                    <i class="fa fa-globe"></i> github
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/ma-shuai-41-32" target="_blank">
                  
                    <i class="fa fa-globe"></i> zhihu
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#A_Fully_Convolutional_Network_for_Left_Ventricle_Segmentation"><span class="nav-number">1.</span> <span class="nav-text">A Fully Convolutional Network for Left Ventricle Segmentation</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Development_Environment"><span class="nav-number">1.1.</span> <span class="nav-text">Development Environment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tutorial_Walkthrough"><span class="nav-number">1.2.</span> <span class="nav-text">Tutorial Walkthrough</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Step_1_3A_Load_the_Sunnybrook_dataset"><span class="nav-number">1.2.1.</span> <span class="nav-text">Step 1: Load the Sunnybrook dataset</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step_3_3A_Apply_trained_Caffe_FCN_model_to_compute_EF"><span class="nav-number">1.3.</span> <span class="nav-text">Step 3: Apply trained Caffe FCN model to compute EF</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step_4_3A_Evaluate_performance"><span class="nav-number">1.4.</span> <span class="nav-text">Step 4: Evaluate performance</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Some_ideas_for_improvement"><span class="nav-number">1.5.</span> <span class="nav-text">Some ideas for improvement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">1.6.</span> <span class="nav-text">References</span></a></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ma Shuai</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    
    

  

    <script type="text/javascript">
      var disqus_shortname = 'ma123shuai-github-io';
      var disqus_identifier = '2015/12/23/A-Fully-Convolutional-Network-for-Left-Ventricle-Segmentation/';
      var disqus_title = 'A Fully Convolutional Network for Left Ventricle Segmentation';
      var disqus_url = 'http://yoursite.com/2015/12/23/A-Fully-Convolutional-Network-for-Left-Ventricle-Segmentation/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  


  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.2" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    motionMiddleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');
      if (CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    };
  });
</script>



  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  
  

<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"3","bdPos":"left","bdTop":"250"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>



</body>
</html>
